import pandas as pd
from sentence_transformers import SentenceTransformer
from pinecone import Pinecone, ServerlessSpec
import io 
from dotenv import load_dotenv
import os


load_dotenv()


API_KEY = os.getenv("PINECONE_API_KEY")
ENVIRONMENT = "us-east-1" 
INDEX_NAME = "product-recommendation-index"
EMBEDDING_MODEL_NAME = 'all-MiniLM-L6-v2' 
BATCH_SIZE = 100 


csv_content = """InvoiceNo,StockCode,Description,Quantity,InvoiceDate,UnitPrice,CustomerID,Country
536365,85123A,WHITE HANGING HEART T-LIGHT HOLDER,6.0,2010-12-01 08:26:00,2.55,17850.0,United Kingdom
536365,71053,WHITE METAL LANTERN,6.0,2010-12-01 08:26:00,3.39,17850.0,United Kingdom
536365,84406B,CREAM CUPID HEARTS COAT HANGER,8.0,2010-12-01 08:26:00,2.75,17850.0,United Kingdom
536365,84029G,KNITTED UNION FLAG HOT WATER BOTTLE,6.0,2010-12-01 08:26:00,3.39,17850.0,United Kingdom
536365,84029E,RED WOOLLY HOTTIE WHITE HEART.,6.0,2010-12-01 08:26:00,3.39,17850.0,United Kingdom
536365,22752,SET 7 BABUSHKA NESTING BOXES,2.0,2010-12-01 08:26:00,7.65,17850.0,United Kingdom
536365,21730,GLASS STAR FROSTED T-LIGHT HOLDER,6.0,2010-12-01 08:26:00,4.25,17850.0,United Kingdom
536366,22633,HAND WARMER UNION JACK,6.0,2010-12-01 08:28:00,1.85,17850.0,United Kingdom
536366,22632,HAND WARMER RED POLKA DOT,6.0,2010-12-01 08:28:00,1.85,17850.0,United Kingdom
536367,84879,ASSORTED COLOUR BIRD ORNAMENT,32.0,2010-12-01 08:34:00,1.69,13047.0,United Kingdom
536367,22745,POPPY'S PLAYHOUSE BEDROOM,6.0,2010-12-01 08:34:00,2.1,13047.0,United Kingdom
536367,22748,POPPY'S PLAYHOUSE KITCHEN,6.0,2010-12-01 08:34:00,2.1,13047.0,United Kingdom
536367,22749,FELTCRAFT PRINCESS CHARLOTTE DOLL,8.0,2010-12-01 08:34:00,3.75,13047.0,United Kingdom
536367,22310,IVORY KNITTED MUG COSY,6.0,2010-12-01 08:34:00,1.65,13047.0,United Kingdom
536367,84969,BOX OF 6 ASSORTED COLOUR TEASPOONS,6.0,2010-12-01 08:34:00,4.25,13047.0,United Kingdom
536367,22623,BOX OF VINTAGE JIGSAW BLOCKS,3.0,2010-12-01 08:34:00,4.95,13047.0,United Kingdom
536367,22622,BOX OF VINTAGE ALPHABET BLOCKS,2.0,2010-12-01 08:34:00,9.95,13047.0,United Kingdom
536367,21754,HOME BUILDING BLOCK WORD,3.0,2010-12-01 08:34:00,5.95,13047.0,United Kingdom
536367,21755,LOVE BUILDING BLOCK WORD,3.0,2010-12-01 08:34:00,5.95,13047.0,United Kingdom
536367,21777,RECIPE BOX WITH METAL HEART,4.0,2010-12-01 08:34:00,7.95,13047.0,United Kingdom
536367,48187,DOORMAT NEW ENGLAND,4.0,2010-12-01 08:34:00,7.95,13047.0,United Kingdom
536368,22960,JAM MAKING SET WITH JARS,6.0,2010-12-01 08:34:00,4.25,13047.0,United Kingdom
536368,22913,RED COAT RACK PARIS FASHION,3.0,2010-12-01 08:34:00,4.95,13047.0,United Kingdom
536368,22912,YELLOW COAT RACK PARIS FASHION,3.0,2010-12-01 08:34:00,4.95,13047.0,United Kingdom
536368,22914,BLUE COAT RACK PARIS FASHION,3.0,2010-12-01 08:34:00,4.95,13047.0,United Kingdom
536369,21756,BATH BUILDING BLOCK WORD,3.0,2010-12-01 08:35:00,5.95,13047.0,United Kingdom
536370,22728,ALARM CLOCK BAKELIKE PINK,24.0,2010-12-01 08:45:00,3.75,12583.0,France
536370,22727,ALARM CLOCK BAKELIKE RED,24.0,2010-12-01 08:45:00,3.75,12583.0,France
536370,22726,ALARM CLOCK BAKELIKE GREEN,12.0,2010-12-01 08:45:00,3.75,12583.0,France
536370,21724,PANDA AND BUNNIES STICKER SHEET,12.0,2010-12-01 08:45:00,0.85,12583.0,France
536370,21883,STARS GIFT TAPE,24.0,2010-12-01 08:45:00,0.65,12583.0,France
536370,10002,INFLATABLE POLITICAL GLOBE,48.0,2010-12-01 08:45:00,0.85,12583.0,France
536370,21791,VINTAGE HEADS AND TAILS CARD GAME,24.0,2010-12-01 08:45:00,1.25,12583.0,France
536370,21035,SET/2 RED RETROSPOT TEA TOWELS,18.0,2010-12-01 08:45:00,2.95,12583.0,France
536370,22326,ROUND SNACK BOXES SET OF4 WOODLAND,24.0,2010-12-01 08:45:00,2.95,12583.0,France
536370,22629,SPACEBOY LUNCH BOX,24.0,2010-12-01 08:45:00,1.95,12583.0,France
536370,22659,LUNCH BOX I LOVE LONDON,24.0,2010-12-01 08:45:00,1.95,12583.0,France
536370,22631,CIRCUS PARADE LUNCH BOX,24.0,2010-12-01 08:45:00,1.95,12583.0,France
536370,22661,CHARLOTTE BAG DOLLY GIRL DESIGN,20.0,2010-12-01 08:45:00,0.85,12583.0,France
536370,21731,RED TOADSTOOL LED NIGHT LIGHT,24.0,2010-12-01 08:45:00,1.65,12583.0,France
536370,22900,SET 2 TEA TOWELS I LOVE LONDON,24.0,2010-12-01 08:45:00,2.95,12583.0,France
536370,21913,VINTAGE SEASIDE JIGSAW PUZZLES,12.0,2010-12-01 08:45:00,3.75,12583.0,France
536370,22540,MINI JIGSAW CIRCUS PARADE,24.0,2010-12-01 08:45:00,0.42,12583.0,France
536370,22544,MINI JIGSAW SPACEBOY,24.0,2010-12-01 08:45:00,0.42,12583.0,France
536370,22492,MINI PAINT SET VINTAGE,36.0,2010-12-01 08:45:00,0.65,12583.0,France
536370,POST,POSTAGE,3.0,2010-12-01 08:45:00,18.0,12583.0,France
536371,22086,PAPER CHAIN KIT 50'S CHRISTMAS,80.0,2010-12-01 09:00:00,2.55,13748.0,United Kingdom
536372,22632,HAND WARMER RED POLKA DOT,6.0,2010-12-01 09:01:00,1.85,17850.0,United Kingdom
536372,22633,HAND WARMER UNION JACK,6.0,2010-12-01 09:01:00,1.85,17850.0,United Kingdom
536373,85123A,WHITE HANGING HEART T-LIGHT HOLDER,6.0,2010-12-01 09:02:00,2.55,17850.0,United Kingdom
536373,71053,WHITE METAL LANTERN,6.0,2010-12-01 09:02:00,3.39,17850.0,United Kingdom
536373,84406B,CREAM CUPID HEARTS COAT HANGER,8.0,2010-12-01 09:02:00,2.75,17850.0,United Kingdom
536373,20679,EDWARDIAN PARASOL RED,6.0,2010-12-01 09:02:00,4.95,17850.0,United Kingdom
536373,37370,RETRO COFFEE MUGS ASSORTED,6.0,2010-12-01 09:02:00,1.06,17850.0,United Kingdom
536373,21871,SAVE THE PLANET MUG,6.0,2010-12-01 09:02:00,1.06,17850.0,United Kingdom
536373,21071,VINTAGE BILLBOARD DRINK ME MUG,6.0,2010-12-01 09:02:00,1.06,17850.0,United Kingdom
536373,21068,VINTAGE BILLBOARD LOVE/HATE MUG,6.0,2010-12-01 09:02:00,1.06,17850.0,United Kingdom
536373,82483,WOOD 2 DRAWER CABINET WHITE FINISH,2.0,2010-12-01 09:02:00,4.95,17850.0,United Kingdom
536373,82486,WOOD S/3 CABINET ANT WHITE FINISH,4.0,2010-12-01 09:02:00,6.95,17850.0,United Kingdom
536373,82482,WOODEN PICTURE FRAME WHITE FINISH,6.0,2010-12-01 09:02:00,2.1,17850.0,United Kingdom
536373,82494L,WOODEN FRAME ANTIQUE WHITE,6.0,2010-12-01 09:02:00,2.55,17850.0,United Kingdom
536373,84029G,KNITTED UNION FLAG HOT WATER BOTTLE,6.0,2010-12-01 09:02:00,3.39,17850.0,United Kingdom
536373,84029E,RED WOOLLY HOTTIE WHITE HEART.,6.0,2010-12-01 09:02:00,3.39,17850.0,United Kingdom
536373,22752,SET 7 BABUSHKA NESTING BOXES,2.0,2010-12-01 09:02:00,7.65,17850.0,United Kingdom
536373,21730,GLASS STAR FROSTED T-LIGHT HOLDER,6.0,2010-12-01 09:02:00,4.25,17850.0,United Kingdom
536374,21258,VICTORIAN SEWING BOX LARGE,32.0,2010-12-01 09:09:00,10.95,15100.0,United Kingdom
536375,85123A,WHITE HANGING HEART T-LIGHT HOLDER,6.0,2010-12-01 09:32:00,2.55,17850.0,United Kingdom
536375,71053,WHITE METAL LANTERN,6.0,2010-12-01 09:32:00,3.39,17850.0,United Kingdom
536375,84406B,CREAM CUPID HEARTS COAT HANGER,8.0,2010-12-01 09:32:00,2.75,17850.0,United Kingdom
536375,20679,EDWARDIAN PARASOL RED,6.0,2010-12-01 09:32:00,4.95,17850.0,United Kingdom
536375,37370,RETRO COFFEE MUGS ASSORTED,6.0,2010-12-01 09:32:00,1.06,17850.0,United Kingdom
536375,21871,SAVE THE PLANET MUG,6.0,2010-12-01 09:32:00,1.06,17850.0,United Kingdom
536375,21071,VINTAGE BILLBOARD DRINK ME MUG,6.0,2010-12-01 09:32:00,1.06,17850.0,United Kingdom
536375,21068,VINTAGE BILLBOARD LOVE/HATE MUG,6.0,2010-12-01 09:32:00,1.06,17850.0,United Kingdom
536375,82483,WOOD 2 DRAWER CABINET WHITE FINISH,2.0,2010-12-01 09:32:00,4.95,17850.0,United Kingdom
536375,82486,WOOD S/3 CABINET ANT WHITE FINISH,4.0,2010-12-01 09:32:00,6.95,17850.0,United Kingdom
536375,82482,WOODEN PICTURE FRAME WHITE FINISH,6.0,2010-12-01 09:32:00,2.1,17850.0,United Kingdom
536375,82494L,WOODEN FRAME ANTIQUE WHITE,6.0,2010-12-01 09:32:00,2.55,17850.0,United Kingdom
536375,84029G,KNITTED UNION FLAG HOT WATER BOTTLE,6.0,2010-12-01 09:32:00,3.39,17850.0,United Kingdom
536375,84029E,RED WOOLLY HOTTIE WHITE HEART.,6.0,2010-12-01 09:32:00,3.39,17850.0,United Kingdom
536375,22752,SET 7 BABUSHKA NESTING BOXES,2.0,2010-12-01 09:32:00,7.65,17850.0,United Kingdom
536375,21730,GLASS STAR FROSTED T-LIGHT HOLDER,6.0,2010-12-01 09:32:00,4.25,17850.0,United Kingdom
536376,22114,HOT WATER BOTTLE TEA AND SYMPATHY,48.0,2010-12-01 09:32:00,3.45,15291.0,United Kingdom
536376,21733,RED HANGING HEART T-LIGHT HOLDER,64.0,2010-12-01 09:32:00,2.55,15291.0,United Kingdom
536377,22632,HAND WARMER RED POLKA DOT,6.0,2010-12-01 09:34:00,1.85,17850.0,United Kingdom
536377,22633,HAND WARMER UNION JACK,6.0,2010-12-01 09:34:00,1.85,17850.0,United Kingdom
536378,22386,JUMBO BAG PINK POLKADOT,10.0,2010-12-01 09:37:00,1.95,14688.0,United Kingdom
536378,85099C,JUMBO  BAG BAROQUE BLACK WHITE,10.0,2010-12-01 09:37:00,1.95,14688.0,United Kingdom
536378,21033,JUMBO BAG CHARLIE AND LOLA TOYS,10.0,2010-12-01 09:37:00,2.95,14688.0,United Kingdom
536378,20723,STRAWBERRY CHARLOTTE BAG,10.0,2010-12-01 09:37:00,0.85,14688.0,United Kingdom
536378,84997B,RED 3 PIECE RETROSPOT CUTLERY SET,12.0,2010-12-01 09:37:00,3.75,14688.0,United Kingdom
536378,84997C,BLUE 3 PIECE POLKADOT CUTLERY SET,6.0,2010-12-01 09:37:00,3.75,14688.0,United Kingdom
536378,21094,SET/6 RED SPOTTY PAPER PLATES,12.0,2010-12-01 09:37:00,0.85,14688.0,United Kingdom
536378,20725,LUNCH BAG RED RETROSPOT,10.0,2010-12-01 09:37:00,1.65,14688.0,United Kingdom
536378,21559,STRAWBERRY LUNCH BOX WITH CUTLERY,6.0,2010-12-01 09:37:00,2.55,14688.0,United Kingdom
536378,22352,LUNCH BOX WITH CUTLERY RETROSPOT,6.0,2010-12-01 09:37:00,2.55,14688.0,United Kingdom
536378,21212,PACK OF 72 RETROSPOT CAKE CASES,120.0,2010-12-01 09:37:00,0.42,14688.0,United Kingdom
536378,21975,PACK OF 60 DINOSAUR CAKE CASES,24.0,2010-12-01 09:37:00,0.55,14688.0,United Kingdom
536378,21977,PACK OF 60 PINK PAISLEY CAKE CASES,24.0,2010-12-01 09:37:00,0.55,14688.0,United Kingdom
536378,84991,60 TEATIME FAIRY CAKE CASES,24.0,2010-12-01 09:37:00,0.55,14688.0,United Kingdom
536378,84519A,TOMATO CHARLIE+LOLA COASTER SET,6.0,2010-12-01 09:37:00,2.95,14688.0,United Kingdom
536378,85183B,CHARLIE & LOLA WASTEPAPER BIN FLORA,48.0,2010-12-01 09:37:00,1.25,14688.0,United Kingdom
536378,85071B,RED CHARLIE+LOLA PERSONAL DOORSIGN,96.0,2010-12-01 09:37:00,0.38,14688.0,United Kingdom
536378,21931,JUMBO STORAGE BAG SUKI,10.0,2010-12-01 09:37:00,1.95,14688.0,United Kingdom
536378,21929,JUMBO BAG PINK VINTAGE PAISLEY,10.0,2010-12-01 09:37:00,1.95,14688.0,United Kingdom
536380,22961,JAM MAKING SET PRINTED,24.0,2010-12-01 09:41:00,1.45,17809.0,United Kingdom
536381,22139,RETROSPOT TEA SET CERAMIC 11 PC,23.0,2010-12-01 09:41:00,4.25,15311.0,United Kingdom
536381,84854,GIRLY PINK TOOL SET,5.0,2010-12-01 09:41:00,4.95,15311.0,United Kingdom
536381,22411,JUMBO SHOPPER VINTAGE RED PAISLEY,10.0,2010-12-01 09:41:00,1.95,15311.0,United Kingdom
536381,82567,"AIRLINE LOUNGE,METAL SIGN",2.0,2010-12-01 09:41:00,2.1,15311.0,United Kingdom
536381,21672,WHITE SPOT RED CERAMIC DRAWER KNOB,6.0,2010-12-01 09:41:00,1.25,15311.0,United Kingdom
536381,22774,RED DRAWER KNOB ACRYLIC EDWARDIAN,24.0,2010-12-01 09:41:00,1.25,15311.0,United Kingdom
536381,22771,CLEAR DRAWER KNOB ACRYLIC EDWARDIAN,24.0,2010-12-01 09:41:00,1.25,15311.0,United Kingdom
536381,71270,PHOTO CLIP LINE,1.0,2010-12-01 09:41:00,1.25,15311.0,United Kingdom
536381,22262,FELT EGG COSY CHICKEN,1.0,2010-12-01 09:41:00,0.85,15311.0,United Kingdom
536381,22637,PIGGY BANK RETROSPOT,1.0,2010-12-01 09:41:00,2.55,15311.0,United Kingdom
536381,21934,SKULL SHOULDER BAG,10.0,2010-12-01 09:41:00,1.65,15311.0,United Kingdom
536381,21169,YOU'RE CONFUSING ME METAL SIGN,3.0,2010-12-01 09:41:00,1.69,15311.0,United Kingdom
536381,21166,COOK WITH WINE METAL SIGN,1.0,2010-12-01 09:41:00,1.95,15311.0,United Kingdom
536381,21175,GIN + TONIC DIET METAL SIGN,2.0,2010-12-01 09:41:00,2.1,15311.0,United Kingdom
536381,37444A,YELLOW BREAKFAST CUP AND SAUCER,1.0,2010-12-01 09:41:00,2.95,15311.0,United Kingdom
536381,37444C,PINK BREAKFAST CUP AND SAUCER,1.0,2010-12-01 09:41:00,2.95,15311.0,United Kingdom
536381,22086,PAPER CHAIN KIT 50'S CHRISTMAS,4.0,2010-12-01 09:41:00,2.95,15311.0,United Kingdom
536381,22083,PAPER CHAIN KIT RETROSPOT,1.0,2010-12-01 09:41:00,2.95,15311.0,United Kingdom
536381,84971S,SMALL HEART FLOWERS HOOK,6.0,2010-12-01 09:41:00,0.85,15311.0,United Kingdom
536381,71270,PHOTO CLIP LINE,3.0,2010-12-01 09:41:00,1.25,15311.0,United Kingdom
536381,47580,TEA TIME DES TEA COSY,2.0,2010-12-01 09:41:00,2.55,15311.0,United Kingdom
536381,22261,FELT EGG COSY WHITE RABBIT,1.0,2010-12-01 09:41:00,0.85,15311.0,United Kingdom
536381,84832,ZINC WILLIE WINKIE  CANDLE STICK,1.0,2010-12-01 09:41:00,0.85,15311.0,United Kingdom
536381,22644,CERAMIC CHERRY CAKE MONEY BANK,1.0,2010-12-01 09:41:00,1.45,15311.0,United Kingdom
536381,21533,RETROSPOT LARGE MILK JUG,1.0,2010-12-01 09:41:00,4.95,15311.0,United Kingdom
536381,21557,SET OF 6 FUNKY BEAKERS,2.0,2010-12-01 09:41:00,2.95,15311.0,United Kingdom
536381,15056BL,EDWARDIAN PARASOL BLACK,2.0,2010-12-01 09:41:00,5.95,15311.0,United Kingdom
536381,15056N,EDWARDIAN PARASOL NATURAL,2.0,2010-12-01 09:41:00,5.95,15311.0,United Kingdom
536381,22646,CERAMIC STRAWBERRY CAKE MONEY BANK,4.0,2010-12-01 09:41:00,1.45,15311.0,United Kingdom
536381,22176,BLUE OWL SOFT TOY,1.0,2010-12-01 09:41:00,2.95,15311.0,United Kingdom
536381,22438,BALLOON ART MAKE YOUR OWN FLOWERS,1.0,2010-12-01 09:41:00,1.95,15311.0,United Kingdom
536381,21731,RED TOADSTOOL LED NIGHT LIGHT,2.0,2010-12-01 09:41:00,1.65,15311.0,United Kingdom
536381,22778,GLASS CLOCHE SMALL,3.0,2010-12-01 09:41:00,3.95,15311.0,United Kingdom
536381,22719,GUMBALL MONOCHROME COAT RACK,36.0,2010-12-01 09:41:00,1.06,15311.0,United Kingdom
536381,21523,DOORMAT FANCY FONT HOME SWEET HOME,10.0,2010-12-01 09:41:00,6.75,15311.0,United Kingdom
C536379,D,Discount,-1.0,2010-12-01 09:41:00,27.5,14527.0,United Kingdom
536382,10002,INFLATABLE POLITICAL GLOBE,12.0,2010-12-01 09:45:00,0.85,16098.0,United Kingdom
536382,21912,VINTAGE SNAKES & LADDERS,8.0,2010-12-01 09:45:00,3.75,16098.0,United Kingdom
536382,21832,CHOCOLATE CALCULATOR,12.0,2010-12-01 09:45:00,1.65,16098.0,United Kingdom
536382,22411,JUMBO SHOPPER VINTAGE RED PAISLEY,10.0,2010-12-01 09:45:00,1.95,16098.0,United Kingdom
536382,22379,RECYCLING BAG RETROSPOT,10.0,2010-12-01 09:45:00,2.1,16098.0,United Kingdom
536382,22381,TOY TIDY PINK POLKADOT,50.0,2010-12-01 09:45:00,1.85,16098.0,United Kingdom
536382,22798,ANTIQUE GLASS DRESSING TABLE POT,8.0,2010-12-01 09:45:00,2.95,16098.0,United Kingdom
536382,22726,ALARM CLOCK BAKELIKE GREEN,4.0,2010-12-01 09:45:00,3.75,16098.0,United Kingdom
536382,22926,IVORY GIANT GARDEN THERMOMETER,12.0,2010-12-01 09:45:00,5.95,16098.0,United Kingdom
536382,22839,3 TIER CAKE TIN GREEN AND CREAM,2.0,2010-12-01 09:45:00,14.95,16098.0,United Kingdom
536382,22838,3 TIER CAKE TIN RED AND CREAM,2.0,2010-12-01 09:45:00,14.95,16098.0,United Kingdom
536382,22783,SET 3 WICKER OVAL BASKETS W LIDS,4.0,2010-12-01 09:45:00,16.95,16098.0,United Kingdom
C536383,35004C,SET OF 3 COLOURED  FLYING DUCKS,-1.0,2010-12-01 09:49:00,4.65,15311.0,United Kingdom
536384,82484,WOOD BLACK BOARD ANT WHITE FINISH,3.0,2010-12-01 09:53:00,6.45,18074.0,United Kingdom
536384,84755,COLOUR GLASS T-LIGHT HOLDER HANGING,48.0,2010-12-01 09:53:00,0.65,18074.0,United Kingdom
536384,22464,HANGING METAL HEART LANTERN,12.0,2010-12-01 09:53:00,1.65,18074.0,United Kingdom
"""


# --- 1. Load Data ---
# Read the CSV content into a pandas DataFrame
try:
    data_io = io.StringIO(csv_content)
    df = pd.read_csv(data_io)
    # Drop rows where 'Description' is missing, as we need it for embeddings
    df.dropna(subset=['Description'], inplace=True)
    df.reset_index(drop=True, inplace=True)
    print(f"Loaded {len(df)} rows from the dataset.")
except Exception as e:
    print(f"Error loading data: {e}")
    exit()

# --- 2. Initialize Embedding Model ---
try:
    model = SentenceTransformer(EMBEDDING_MODEL_NAME)
    print(f"Loaded embedding model: {EMBEDDING_MODEL_NAME}")
    print(f"Embedding dimension: {model.get_sentence_embedding_dimension()}")
    if model.get_sentence_embedding_dimension() != 384:
        print("WARNING: The embedding model's dimension does not match the recommended 384 for this setup.")
        print("Please ensure your Pinecone index is created with the correct dimension to avoid errors.")
except Exception as e:
    print(f"Error loading embedding model: {e}")
    print("Please ensure 'sentence-transformers' library is installed (`pip install sentence-transformers`).")
    exit()

# --- 3. Initialize Pinecone and connect to index ---
try:
    pc = Pinecone(api_key=API_KEY, environment=ENVIRONMENT)
    index = pc.Index(INDEX_NAME)
    print(f"Connected to Pinecone index: {INDEX_NAME}")
    # Verify index description to check its dimension
    index_description = pc.describe_index(INDEX_NAME)
    print(f"Pinecone index dimension: {index_description.dimension}")
    if index_description.dimension != model.get_sentence_embedding_dimension():
        print(f"CRITICAL ERROR: Pinecone index dimension ({index_description.dimension}) does not match "
              f"embedding model dimension ({model.get_sentence_embedding_dimension()}).")
        print("You must delete and recreate your Pinecone index with the correct dimension "
              f"(`dimension={model.get_sentence_embedding_dimension()}`).")
        exit()

except Exception as e:
    print(f"Error initializing Pinecone or connecting to index: {e}")
    print("Please ensure your Pinecone API key and environment are correct, and the index exists.")
    exit()

# --- 4. Generate Embeddings and Upsert Data ---
print("Generating embeddings and upserting data...")
vectors_to_upsert = []
for i, row in df.iterrows():
    try:
        # Create a unique ID for each vector
        # Combining StockCode and index to ensure uniqueness, as StockCode might not be unique per row
        vector_id = f"{row['StockCode']}-{i}"

        # Get description and ensure it's a string
        description = str(row['Description'])
        embedding = model.encode(description).tolist()

        # Prepare metadata, converting non-standard types to string for Pinecone compatibility if needed
        metadata = {
            "StockCode": str(row['StockCode']),
            "Description": description,
            "UnitPrice": float(row['UnitPrice']),
            "Country": str(row['Country'])
        }

        vectors_to_upsert.append((vector_id, embedding, metadata))

        # Upsert in batches
        if len(vectors_to_upsert) == BATCH_SIZE:
            index.upsert(vectors=vectors_to_upsert)
            vectors_to_upsert = [] # Clear the batch
            print(f"Upserted {i + 1} vectors so far...")

    except Exception as e:
        print(f"Skipping row {i} due to error: {e}")
        continue # Continue to the next row even if one fails

# Upsert any remaining vectors
if vectors_to_upsert:
    index.upsert(vectors=vectors_to_upsert)
    print(f"Upserted remaining {len(vectors_to_upsert)} vectors.")

print("\nData upserting process completed!")
print(f"Total vectors in Pinecone index: {index.describe_index_stats().total_vector_count}")

print("\nNow you are ready to perform vector similarity searches on your Pinecone index!")
